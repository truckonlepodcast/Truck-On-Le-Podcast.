import React, { useEffect, useState } from "react";
import { View, Text, FlatList, Image, TouchableOpacity, ActivityIndicator } from "react-native";
import * as rssParser from "react-native-rss-parser";
import { Audio } from "expo-av";

// Ton logo h√©berg√©
const LOGO_URL = "https://i.ibb.co/1RHgdnY/truckon-logo.jpg";

// Flux RSS de ton podcast
const RSS_URL = "https://anchor.fm/s/ac4f88bc/podcast/rss";

export default function App() {
  const [episodes, setEpisodes] = useState([]);
  const [loading, setLoading] = useState(true);
  const [sound, setSound] = useState(null);
  const [currentEpisode, setCurrentEpisode] = useState(null);

  useEffect(() => {
    fetch(RSS_URL)
      .then((response) => response.text())
      .then((responseData) => rssParser.parse(responseData))
      .then((rss) => {
        setEpisodes(rss.items);
        setLoading(false);
      })
      .catch((error) => {
        console.error(error);
        setLoading(false);
      });
  }, []);

  async function playEpisode(url, title) {
    try {
      if (sound) {
        await sound.stopAsync();
        await sound.unloadAsync();
      }
      const { sound: newSound } = await Audio.Sound.createAsync({ uri: url });
      setSound(newSound);
      setCurrentEpisode(title);
      await newSound.playAsync();
    } catch (error) {
      console.error("Erreur lecture:", error);
    }
  }

  if (loading) {
    return (
      <View style={{ flex: 1, justifyContent: "center", alignItems: "center", backgroundColor: "black" }}>
        <ActivityIndicator size="large" color="red" />
        <Text style={{ color: "white", marginTop: 10 }}>Chargement...</Text>
      </View>
    );
  }

  return (
    <View style={{ flex: 1, backgroundColor: "black", paddingTop: 40 }}>
      {/* Logo + titre */}
      <View style={{ alignItems: "center", marginBottom: 20 }}>
        <Image source={{ uri: LOGO_URL }} style={{ width: 180, height: 180, borderRadius: 20 }} />
        <Text style={{ color: "white", fontSize: 24, fontWeight: "bold", marginTop: 10 }}>
          üöõ Truck On Le Podcast
        </Text>
      </View>

      {/* Lecteur en cours */}
      {currentEpisode && (
        <View style={{ padding: 10, backgroundColor: "#222", margin: 10, borderRadius: 10 }}>
          <Text style={{ color: "red", fontWeight: "bold" }}>‚ñ∂Ô∏è En lecture :</Text>
          <Text style={{ color: "white" }}>{currentEpisode}</Text>
        </View>
      )}

      {/* Liste des √©pisodes */}
      <FlatList
        data={episodes}
        keyExtractor={(item, index) => index.toString()}
        renderItem={({ item }) => (
          <TouchableOpacity
            onPress={() => playEpisode(item.enclosures[0].url, item.title)}
            style={{
              backgroundColor: "#1a1a1a",
              padding: 15,
              marginVert
