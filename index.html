import React, { useEffect, useState, useRef } from "react";
import {
  View,
  Text,
  FlatList,
  Image,
  TouchableOpacity,
  ActivityIndicator,
  StyleSheet,
} from "react-native";
import { Audio } from "expo-av";

// Logo h√©berg√©
const LOGO_URL = "https://i.ibb.co/1RHgdnY/truckon-logo.jpg";
// Flux RSS
const RSS_URL = "https://anchor.fm/s/ac4f88bc/podcast/rss";

export default function App() {
  const [episodes, setEpisodes] = useState([]);
  const [loading, setLoading] = useState(true);
  const soundRef = useRef(null);
  const [currentEpisode, setCurrentEpisode] = useState(null);
  const [isPlaying, setIsPlaying] = useState(false);

  // Parse RSS avec regex (pas besoin de DOMParser)
  const parseRSS = (xmlText) => {
    const items = [];
    const itemRegex = /<item>([\s\S]*?)<\/item>/g;
    let match;
    while ((match = itemRegex.exec(xmlText)) !== null) {
      const itemBlock = match[1];
      const title = (itemBlock.match(/<title><!\[CDATA\[(.*?)\]\]><\/title>/) ||
        itemBlock.match(/<title>(.*?)<\/title>/))?.[1] || "√âpisode";
      const description =
        (itemBlock.match(/<description><!\[CDATA\[(.*?)\]\]><\/description>/) ||
          itemBlock.match(/<description>(.*?)<\/description>/))?.[1] || "";
      const audio =
        (itemBlock.match(/<enclosure[^>]*url="(.*?)"/) || [])[1] || "";

      items.push({
        title,
        description,
        audio,
      });
    }
    return items;
  };

  useEffect(() => {
    (async () => {
      try {
        const response = await fetch(RSS_URL);
        const text = await response.text();
        const parsed = parseRSS(text);
        setEpisodes(parsed);
      } catch (e) {
        console.error("Erreur RSS:", e);
      } finally {
        setLoading(false);
      }
    })();

    return () => {
      if (soundRef.current) {
        soundRef.current.unloadAsync();
        soundRef.current = null;
      }
    };
  }, []);

  const playEpisode = async (episode) => {
    try {
      if (soundRef.current) {
        await soundRef.current.stopAsync();
        await soundRef.current.unloadAsync();
      }
      const { sound } = await Audio.Sound.createAsync(
        { uri: episode.audio },
        { shouldPlay: true }
      );
      soundRef.current = sound;
      setCurrentEpisode(episode.title);
      setIsPlaying(true);
    } catch (err) {
      console.error("Erreur lecture:", err);
    }
  };

  const pauseResume = async () => {
    if (!soundRef.current) return;
    const status = await soundRef.current.getStatusAsync();
    if (status.isPlaying) {
      await soundRef.current.pauseAsync();
      setIsPlaying(false);
    } else {
      await soundRef.current.playAsync();
      setIsPlaying(true);
    }
  };

  const stop = async () => {
    if (!soundRef.current) return;
    await soundRef.current.stopAsync();
    await soundRef.current.unloadAsync();
    soundRef.current = null;
    setCurrentEpisode(null);
    setIsPlaying(false);
  };

  if (loading) {
    return (
      <View style={styles.center}>
        <ActivityIndicator size="large" color="red" />
        <Text style={styles.loadingText}>Chargement...</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      {/* En-t√™te */}
      <View style={styles.header}>
        <Image source={{ uri: LOGO_URL }} style={styles.logo} />
        <Text style={styles.title}>üöõ Truck On Le Podcast</Text>
      </View>

      {/* Lecteur */}
      {currentEpisode && (
        <View style={styles.player}>
          <Text style={styles.playerLabel}>‚ñ∂Ô∏è En lecture :</Text>
          <Text style={styles.playerTitle}>{currentEpisode}</Text>
          <View style={styles.controls}>
            <TouchableOpacity onPress={pauseResume} style={styles.controlButton}>
              <Text style={styles.controlText}>{isPlaying ? "‚è∏ Pause" : "‚ñ∂Ô∏è Lecture"}</Text>
            </TouchableOpacity>
            <TouchableOpacity onPress={stop} style={styles.controlButton}>
              <Text style={styles.controlText}>‚èπÔ∏è Stop</Text>
            </TouchableOpacity>
          </View>
        </View>
      )}

      {/* Liste des √©pisodes */}
      <FlatList
        data={episodes}
        keyExtractor={(_, index) => index.toString()}
        renderItem={({ item }) => (
          <TouchableOpacity
            onPress={() => playEpisode(item)}
            style={styles.episodeCard}
          >
            <Text style={styles.episodeTitle}>{item.title}</Text>
            <Text style={styles.episodeDesc} numberOfLines={2}>
              {item.description.replace(/<[^>]*>?/gm, "")}
            </Text>
          </TouchableOpacity>
        )}
      />
    </View>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: "black", paddingTop: 40 },
  center: { flex: 1, justifyContent: "center", alignItems: "center", backgroundColor: "black" },
  loadingText: { color: "white", marginTop: 10 },
  header: { alignItems: "center", marginBottom: 16 },
  logo: { width: 160, height: 160, borderRadius: 12 },
  title: { color: "white", fontSize: 22, fontWeight: "700", marginTop: 10 },
  player: { padding: 12, backgroundColor: "#222", margin: 12, borderRadius: 10 },
  playerLabel: { color: "red", fontWeight: "700" },
  playerTitle: { color: "white", marginTop: 4, fontWeight: "600" },
  controls: { flexDirection: "row", marginTop: 8 },
  controlButton: { marginRight: 12, padding: 8, backgroundColor: "#444", borderRadius: 6 },
  controlText: { color: "white", fontSize: 16 },
  episodeCard: {
    backgroundColor: "#1a1a1a",
    padding: 14,
    marginVertical: 6,
    marginHorizontal: 14,
    borderRadius: 10,
    borderLeftWidth: 5,
    borderLeftColor: "red",
  },
  episodeTitle: { color: "white", fontSize: 16, fontWeight: "700" },
  episodeDesc: { color: "gray", marginTop: 6 },
});
